# ストーリーからYAML生成ルール

このドキュメントは、Claude Codeがユーザーとの対話を通じて簡易YAMLを生成する際のルールを定義します。

---

## 📋 目的

ユーザーが自然な日本語でストーリーアイデアを話すだけで、システムが認識できる **簡易YAML** を生成する。

---

## 🎯 基本方針

### ✅ やること
- ユーザーとの対話を通じて必要な情報を引き出す
- 既存のフォーマットに厳密に従う
- 不明点は質問して確認する
- 最終的に有効な簡易YAMLを出力する

### ❌ やらないこと
- 勝手に新しいキャラクターを作らない
- 存在しないレイアウトパターンを使わない
- フォーマットを改変しない
- 脱線した提案をしない

---

## 📊 使用可能な要素

### キャラクター（2名のみ）

| キャラクター名 | 説明 | 利用可能な感情 |
|--------------|------|--------------|
| **TEN** | 黒髪メガネの若手エンジニア（chibi） | 通常、悩み、驚き、喜び、決意、説明 |
| **CLAUDECODE** | 宇宙服を着た可愛いロボット（chibi） | 通常、提案、作業中、発見、承認、説明 |

**重要**: この2名以外のキャラクターは使用できません。

### レイアウトパターン（4種類）

| パターン名 | コマ数 | 用途 |
|----------|--------|------|
| `pattern_3panel` | 3コマ | 起承結のシンプルな構成 |
| `pattern_4panel_equal` | 4コマ | 起承転結の標準構成 |
| `pattern_5panel` | 5コマ | 詳細な展開 |
| `pattern_6panel` | 6コマ | 複雑なストーリー |

### 感情表現（英語変換が自動実行されます）

**TEN の感情:**
- 通常、悩み、驚き、喜び、決意、説明

**CLAUDECODE の感情:**
- 通常、提案、作業中、発見、承認、説明

---

## 🔄 対話フロー

### Step 1: ストーリーアイデアを聞く

ユーザーから以下を引き出す:
- どんな内容の漫画を作りたいか
- 何を伝えたいか（メッセージ/オチ）
- 技術的なトピックがあれば何か

**質問内容:**
```
どんな内容の漫画を作りたいですか？
例: 「新しい技術を学んだ話」「バグに悩んだ話」「便利なツールを見つけた話」
```

---

### Step 2: 台本を生成する

**⚠️ 重要: Claude Codeが台本を生成します**

Step 1で聞いたストーリーアイデアを元に、台本を生成します。

**生成する内容:**
- **セリフ（メイン）**: 各コマの会話内容
- **簡単な感情表現**: 喜怒哀楽レベル（例: 困っている、嬉しい、驚く）
  - ⚠️ 詳細なポーズや表情は指定しない（後のステップで参照画像から選択）

**基本ルール:**
- 基本は**4コマ/ページ**（起承転結）
- コマ数が4の倍数でない場合は自動調整
- 複数ページの場合は「ページX/Y」形式で提示

**台本フォーマット例:**
```
【台本】 全12コマ（3ページ構成）

ページ1/3
コマ1: TEN（困っている）「〇〇で悩んでる...」
コマ2: CLAUDECODE（提案する）「〇〇を使えばいいよ！」
コマ3: TEN（驚く）「なるほど!」
コマ4: TEN（試す）「やってみよう」

ページ2/3
コマ5: TEN（集中）「実装中...」
コマ6: CLAUDECODE（サポート）「ここはこうだよ」
コマ7: TEN（困惑）「あれ？エラーが...」
コマ8: CLAUDECODE（説明）「それは〇〇が原因だね」

ページ3/3
コマ9: TEN（理解）「わかった！」
コマ10: TEN（作業）「修正してみる」
コマ11: TEN（成功）「動いた！」
コマ12: TEN（喜ぶ）「できた！」
```

**ユーザーへの確認:**
- 生成した台本をユーザーに提示
- 修正要望があれば対応
- OKが出たら次のステップへ

**決定事項:**
- ストーリー全体のセリフ
- 各コマの簡単な感情表現
- ページ数（自動的に確定）

---

### Step 3: 各コマの詳細を確定

**⚠️ 重要: Claude Codeが各コマの詳細を自動的に決定します**

Step 2で作成した台本を元に、以下の3つを確定します：

#### 1. 感情のマッピング

台本の簡単な感情表現を、参照画像が存在する正式な6種類の感情にマッピングします。

**TEN の感情マッピング:**
- 困っている、悩んでいる → **悩み**
- 嬉しい、喜んでいる → **喜び**
- 驚く、ビックリ → **驚き**
- 決める、やる気 → **決意**
- 説明する、教える → **説明**
- その他、普通 → **通常**

**CLAUDECODE の感情マッピング:**
- 提案する、アイデア → **提案**
- 作業する、コーディング → **作業中**
- 発見、ひらめき → **発見**
- 承認、OK → **承認**
- 説明する、教える → **説明**
- その他、普通 → **通常**

#### 2. 背景の決定

各コマの背景パターンを以下から選択：

**背景パターン一覧:**
- **デスク**: デスク環境、作業中の様子
- **モニター**: コード画面がメイン
- **オフィス**: 会議室、職場の風景
- **外**: 屋外、外の風景
- **シンプル**: 無地、グラデーション背景

#### 3. 小物の選択

必要に応じて小物を選択：

**小物一覧:**
- **NOTEPC**: ノートパソコン（コード画面表示）
- **PC**: デスクトップモニター（コード画面表示）
- **なし**: 小物不要

#### 確定内容の提示例

```
【各コマの詳細】

コマ1: TEN
  感情: 悩み
  セリフ: 「〇〇で悩んでる...」
  背景: デスク
  小物: NOTEPC

コマ2: CLAUDECODE
  感情: 提案
  セリフ: 「〇〇を使えばいいよ！」
  背景: デスク
  小物: なし

コマ3: TEN
  感情: 驚き
  セリフ: 「なるほど!」
  背景: デスク
  小物: なし

コマ4: TEN
  感情: 喜び
  セリフ: 「できた！」
  背景: デスク
  小物: PC
```

**ユーザーへの確認:**
- 確定内容をユーザーに提示
- 修正要望があれば対応
- OKが出たら次のステップへ

---

### Step 4: タイトルを決める

**質問内容:**
```
この漫画のタイトルを決めましょう。
例: 「〇〇を学んだ話 #1」「〇〇でハマった話」
```

---

### Step 5: 確認とYAML生成

全情報を整理して、ユーザーに最終確認:

```
以下の内容で簡易YAMLを生成します。よろしいですか？

【タイトル】...
【ページ数】3ページ（12コマ）
【ストーリー】
ページ1/3
  コマ1: TEN（悩み）「...」背景: デスク / 小物: NOTEPC
  コマ2: CLAUDECODE（提案）「...」背景: デスク / 小物: なし
  コマ3: TEN（驚き）「...」背景: デスク / 小物: なし
  コマ4: TEN（喜び）「...」背景: デスク / 小物: なし
...
```

OKが出たら、**簡易YAMLを生成してファイルに書き込む**。

---

## 📝 出力フォーマット（厳守）

```yaml
# 簡易ストーリー記述フォーマット
# このシンプルな記述から完全な構造化YAMLを自動生成します

story_title: "ここにタイトル"
layout_pattern: "pattern_4panel_equal"  # 基本は4コマ（pattern_3panel, pattern_5panel, pattern_6panelも可能）

scenes:
  - character: TEN
    emotion: 悩み
    dialogue: "セリフ内容"
    background: "デスク"
    description: "パソコンの前で考え込んでいる"
    tools: "NOTEPC"  # NOTEPC, PC, または空文字列

  - character: CLAUDECODE
    emotion: 提案
    dialogue: "セリフ内容"
    background: "デスク"
    description: "指を立てて提案している"
    tools: ""  # 小物なし

  - character: TEN
    emotion: 驚き
    dialogue: "セリフ内容"
    background: "デスク"
    description: "目を輝かせている"
    tools: ""

  - character: TEN
    emotion: 喜び
    dialogue: "セリフ内容"
    background: "デスク"
    description: "ガッツポーズ"
    tools: "PC"

  # 選択したコマ数分だけ続く
```

**重要な注意点:**
- `scenes` の数は `layout_pattern` で指定したコマ数と一致させる
- `character` は `TEN` または `CLAUDECODE` のみ
- `emotion` は各キャラクターの利用可能な感情（通常、悩み、驚き、喜び、決意、説明 / 通常、提案、作業中、発見、承認、説明）
- `background` は背景パターン（デスク、モニター、オフィス、外、シンプル）
- `tools` は小物（NOTEPC、PC、空文字列）
- すべてのフィールドは必須

---

## ⚠️ 禁止事項

1. ❌ 新しいキャラクターを作らない
2. ❌ 存在しないlayout_patternを使わない
3. ❌ 定義されていない感情を使わない
4. ❌ YAMLフォーマットを改変しない
5. ❌ コマ数とscenes数を不一致にしない
6. ❌ 必須フィールドを省略しない
7. ❌ 勝手な判断で内容を変更しない

---

## 💡 対話のコツ

### 自然な流れを重視
- 質問は一度に1〜2個ずつ
- ユーザーの意図を汲み取る
- 曖昧な部分は確認する

### 具体例を示す
- 「こんな感じですか？」と例示
- 選択肢を提示する

### 柔軟に対応
- ユーザーが詳細に指定する場合: そのまま使う
- ユーザーが「お任せ」の場合: 提案して確認

---

## 📂 ファイル保存

### 単一ページの場合
```
stories/{タイトルから生成した名前}.yaml
```

### 複数ページの場合
各ページを個別のYAMLファイルとして保存:
```
stories/{ベース名}_01.yaml
stories/{ベース名}_02.yaml
stories/{ベース名}_03.yaml
```

**ファイル名ルール:**
- 日本語は避ける
- 小文字＋アンダースコア
- 複数ページは連番 (`_01`, `_02`...) を付ける

---

## 🎯 成功基準

以下を満たせば成功:
- ✅ 既存のフォーマットに完全準拠
- ✅ すべての必須項目が埋まっている
- ✅ キャラクター・感情・パターンが有効
- ✅ YAMLとして構文エラーがない
- ✅ `expand_story.py` で処理できる
- ✅ **画像生成まで完了する**

---

## 🚀 YAML生成後の実行手順

### Step 6: 画像を生成する

**簡易YAMLを作成しただけでは終わりではありません。必ず画像生成まで実行してください。**

#### 実行方法（2ステップ）

各YAMLファイルに対して以下を実行します：

**Step 6-1: YAML展開**
```bash
python3 scripts/expand_story.py stories/story_name.yaml
```
これで `stories/story_name_expanded.yaml` が生成されます。

**Step 6-2: 画像生成**

まず仮想環境のPythonを探します：
```bash
ls venv*/Scripts/python.exe  # Windows
ls venv*/bin/python           # Linux/Mac
```

見つけたパスで画像生成を実行：
```bash
# 基本は --count 4 で4枚生成し、良いものを選ぶ
venv_win/Scripts/python.exe scripts/generate_from_yaml.py stories/story_name_expanded.yaml --count 4
```

**複数生成について:**
- `--count` オプションで生成枚数を指定（1-4枚）
- AI生成は確率的なため、レイアウトやキャラクター配置が正しくない場合があります
- **推奨: `--count 4` で4枚生成し、最も良いものを選択する**
- ファイル名: `story_name_expanded_generated_1.png`, `_2.png`, `_3.png`, `_4.png`

#### 📁 出力ディレクトリ構造

生成された画像は以下の構造で保存されます：
```
output/
  └── 2025-11/        # 年月
      └── 13/         # 日付
          ├── 1/      # セッション1（--count 4 で生成）
          │   ├── story_01_expanded_generated_1.png
          │   ├── story_01_expanded_generated_2.png
          │   ├── story_01_expanded_generated_3.png
          │   └── story_01_expanded_generated_4.png
          ├── 2/      # セッション2
          │   └── story_02_expanded_generated.png
          └── 3/      # セッション3（複数ページ）
              ├── page1_expanded_generated_1.png
              ├── page1_expanded_generated_2.png
              ├── page1_expanded_generated_3.png
              ├── page1_expanded_generated_4.png
              ├── page2_expanded_generated_1.png
              ├── page2_expanded_generated_2.png
              ├── page2_expanded_generated_3.png
              └── page2_expanded_generated_4.png
```

- 実行するたびに新しいセッションフォルダ（1, 2, 3...）が作成されます
- 同じ日付内で連番になります
- `--count` オプションで複数生成すると、番号付きファイルが作成されます

#### 🔗 複数ページを同じフォルダにまとめる方法

**重要**: 複数ページのストーリー（カルーセル投稿など）を同じフォルダに保存したい場合は、`--session-folder` オプションを使用します。

**複数ページの場合の例：**
```bash
# セッションフォルダ番号を決める（例: 4）
SESSION=4

# 1ページ目（4枚生成して良いものを選ぶ）
python3 scripts/expand_story.py stories/ai_aruaru_01.yaml
venv_win/Scripts/python.exe scripts/generate_from_yaml.py stories/ai_aruaru_01_expanded.yaml --session-folder $SESSION --count 4

# 2ページ目（同じフォルダに保存）
python3 scripts/expand_story.py stories/ai_aruaru_02.yaml
venv_win/Scripts/python.exe scripts/generate_from_yaml.py stories/ai_aruaru_02_expanded.yaml --session-folder $SESSION --count 4

# 3ページ目以降も同様に繰り返す（すべて同じ --session-folder を指定）
python3 scripts/expand_story.py stories/ai_aruaru_03.yaml
venv_win/Scripts/python.exe scripts/generate_from_yaml.py stories/ai_aruaru_03_expanded.yaml --session-folder $SESSION --count 4
```

**注意**: 複数生成を使うと、各ページで4枚ずつ生成されるため、良いものを選んで不要なファイルは削除してください。

**結果:**
```
output/2025-11/12/4/
  ├── ai_aruaru_01_expanded_generated_1.png
  ├── ai_aruaru_01_expanded_generated_2.png
  ├── ai_aruaru_01_expanded_generated_3.png
  ├── ai_aruaru_01_expanded_generated_4.png
  ├── ai_aruaru_02_expanded_generated_1.png
  ├── ai_aruaru_02_expanded_generated_2.png
  ├── ai_aruaru_02_expanded_generated_3.png
  ├── ai_aruaru_02_expanded_generated_4.png
  ├── ai_aruaru_03_expanded_generated_1.png
  ├── ai_aruaru_03_expanded_generated_2.png
  ├── ai_aruaru_03_expanded_generated_3.png
  └── ai_aruaru_03_expanded_generated_4.png
```

各ページから最も良い画像を選び、不要なファイルを削除してください。

**セッション番号の選び方:**
1. **必ずシステム時刻を確認**: `date` コマンドで現在の日付を確認
2. **その日付のフォルダを確認**: `ls output/年月/日付/` で既存のセッション番号を確認
3. **次の番号を使う**: 最大のセッション番号+1を使う（例: 最大が3なら、4を使う）

**重要**: 日付が変わると新しいフォルダが作成され、セッション番号は1から始まります。必ず最初にシステム時刻を確認してください。

**出力確認:**
生成された画像は `output/年月/日付/セッション番号/` ディレクトリに保存されます。
- `--count 1` の場合: `{story_name}_expanded_generated.png`
- `--count 4` の場合: `{story_name}_expanded_generated_1.png`, `_2.png`, `_3.png`, `_4.png`

---

## 📚 参考ファイル

対話中に必要に応じて参照:
- `templates/character_templates.yaml` - キャラクター定義
- `templates/layout_patterns.yaml` - レイアウト定義
- `stories/simple_story_example.yaml` - 成功例

---

## 📱 Step 7: 投稿用テキストを生成する（カルーセル投稿の場合）

**複数ページのストーリーの場合、セリフ一覧とキャプションをまとめた投稿用テキストを生成します。**

### 生成内容

以下の2つをまとめた1つのテキストファイルを作成：

1. **セリフ一覧**: 各ページのセリフを1行ずつ抽出（箇条書きマークなし、プレーンテキスト）
2. **キャプション**: SNS投稿用のキャプション

### 実行方法

**⚠️ 重要: Claude Codeが各YAMLファイルから情報を読み取って、投稿用テキストを生成します**

1. 各ページの簡易YAMLファイルを読み込む
2. 各コマの `dialogue` フィールドからセリフを抽出
3. タイトルとストーリーの流れを要約
4. 投稿用テキストファイルを生成

### 出力フォーマット例

```
【ドタバタデバッグ】

■ セリフ一覧

ページ1:
うわ〜テストが全然通らない...
エラーメッセージ見ても原因がわからない...
どうしたの？
テストが全部失敗するんだ...

ページ2:
じゃあまずテストファイルを確認してみよう！
ファイルは問題なさそう...
次は依存関係をチェック！
これも大丈夫みたい...

ページ3:
キャッシュクリアしてみる？
やってみたけどダメだ...
環境変数とか設定ファイルは？
全部確認したのに...なんで...

ページ4:
ねえ、そもそもテストコマンド何使ってる？
npm test だけど...
あっ...npm install忘れてない？
あっ！！！それだ！！！

■ キャプション
テストが通らなくて悩んでいたら、まさかの基本的なミスだった...！
npm installを忘れるという超初歩的なやらかし😅

みなさんも経験ありませんか？
こういうシンプルなミスほど気づきにくいんですよね。

■ ハッシュタグ候補（10個程度提案、後で選択）
#エンジニア #プログラミング #エンジニアあるある #プログラミング初心者 #駆け出しエンジニア #コーディング #npm #テスト #デバッグ #初心者エンジニアと繋がりたい
```

### 保存先

```
output/年月/日付/セッション番号/投稿用テキスト.txt
```

例: `output/2025-11/13/11/投稿用テキスト.txt`

### 実行タイミング

- 画像生成（Step 6）が完了した後
- 複数ページのストーリーの場合に実行
- 単一ページの場合は省略可能

---

**このルールに従って、ユーザーとの対話を通じて高品質な簡易YAMLを生成し、画像生成、投稿用テキスト生成まで完了させてください。**
